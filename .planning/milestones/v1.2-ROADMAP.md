# Milestone v1.2: Streaming & Long-Running Task Resilience — Archived Roadmap

**Goal:** Make the relay robust for complex, long-running Claude CLI tasks.
**Status:** Complete
**Started:** 2026-02-13
**Completed:** 2026-02-13

## Stats

- **Phases:** 2 (Phase 12-13)
- **Requirements:** 9/9 delivered
- **Commits:** 6
- **LOC added:** ~210 net (relay.ts grew from ~2,501 to 2,711 lines)
- **Files changed:** 2 core files (relay.ts, CLAUDE.md)
- **Dependencies added:** 0

## Key Accomplishments

1. **Streaming engine** — Replaced `--output-format json` with `stream-json` NDJSON line-by-line parsing in `callClaude()`, using native Bun `ReadableStream.getReader()` API
2. **Activity-based timeout** — 15-minute inactivity timer reset on every stream event, replacing the old 5-minute blind timeout that killed healthy slow processes
3. **Typing indicators** — Continuous `sendChatAction("typing")` every 4 seconds during Claude work via `createLivenessReporter()`
4. **Tool-use progress** — Real-time status messages showing what Claude is doing ("Reading file, Running command..."), throttled to max 1 per 15 seconds
5. **Clean UX** — Status message sent once, edited on updates, deleted when response arrives — no leftover progress spam

## Phase Details

| Phase | Goal | Requirements | Status |
|-------|------|--------------|--------|
| 12 - Streaming Engine | Replace JSON output with stream-json NDJSON parsing and activity-based timeout | STREAM-01, STREAM-02, STREAM-03, TIMEOUT-01, TIMEOUT-02 | Done |
| 13 - Liveness & Progress | Keep Telegram showing activity and send progress updates during long tasks | LIVE-01, LIVE-02, PROG-01, PROG-02 | Done |

### Phase 12 — Streaming Engine
Core refactor of `callClaude()`. Switched from `--output-format json` to `--output-format stream-json --verbose`. Parses NDJSON lines incrementally via ReadableStream chunked reading. Extracts session_id from `system/init` event, result text from `result` event. Resets inactivity timer on every parsed line. Timeout bumped to 15 min. Orphan cleanup preserved. All callers unchanged.

### Phase 13 — Liveness & Progress
Added `createLivenessReporter()` factory with typing indicator interval (4s) and throttled progress messages (15s). Parses `assistant` events with `tool_use` content to extract tool names, mapped via `TOOL_DISPLAY_NAMES` (12 common tools). Single editable status message pattern (send once, edit on updates, delete on cleanup). All 4 message handlers wired with try/finally cleanup. Heartbeat and cron callers unchanged.

## Dependencies

```
Phase 12 (Streaming Engine)
  └─> Phase 13 (Liveness & Progress)
```

## Deferred Items

- **STREAM-PARTIAL**: Token-by-token text streaming to Telegram — adds complexity
- **PROG-EDIT**: Show edit summaries in progress messages — needs careful formatting
- **COST-01**: Show API cost from result event — nice-to-have

---

*Archived: 2026-02-13*
