# Requirements: Milestone v1.2 — Streaming & Long-Running Task Resilience (Archived)

**Defined:** 2026-02-13
**Completed:** 2026-02-13
**Core Value:** Make the relay robust for complex, long-running Claude CLI tasks by switching to streaming output, keeping the user informed of progress, and eliminating premature timeouts.

## Problem Statement

When Claude works on complex tasks (deep research, multi-file edits, subagent orchestration), the relay's `callClaude()` function:
1. Uses `--output-format json` which gives zero feedback until completion
2. Monitors only stderr for activity — misses long thinking pauses where stderr is silent
3. Has a 5-minute inactivity timeout that kills healthy but slow processes
4. Sends Telegram `typing` once (expires after ~5 seconds), making the bot look dead

## Requirements

### Streaming Engine

- [x] **STREAM-01**: Switch `callClaude()` from `--output-format json` to `--output-format stream-json --verbose` — Phase 12
- [x] **STREAM-02**: Parse stream-json events incrementally — handle `system/init`, `assistant` (text + tool_use), `user` (tool_result), and `result` event types — Phase 12
- [x] **STREAM-03**: Reset inactivity timer on every stream-json event (replacing stderr-only monitoring) — Phase 12

### Liveness Indicators

- [x] **LIVE-01**: Send Telegram `typing` chat action every 4-5 seconds while Claude is working — Phase 13
- [x] **LIVE-02**: Stop typing indicator interval when Claude finishes or times out — Phase 13

### Timeout Tuning

- [x] **TIMEOUT-01**: Increase inactivity timeout from 5 minutes to 15 minutes — Phase 12
- [x] **TIMEOUT-02**: Ensure orphan process cleanup (`killOrphanedProcesses`) still works with the new timeout and streaming mode — Phase 12

### Progress Feedback

- [x] **PROG-01**: Send intermediate Telegram messages showing what Claude is doing — tool names parsed from `assistant` events with `tool_use` content blocks — Phase 13
- [x] **PROG-02**: Throttle progress messages to avoid spam — max 1 progress update every 15 seconds, collapsing rapid tool calls into a single message — Phase 13

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| STREAM-01 | 12 | Done |
| STREAM-02 | 12 | Done |
| STREAM-03 | 12 | Done |
| LIVE-01 | 13 | Done |
| LIVE-02 | 13 | Done |
| TIMEOUT-01 | 12 | Done |
| TIMEOUT-02 | 12 | Done |
| PROG-01 | 13 | Done |
| PROG-02 | 13 | Done |

**Coverage:** 9/9 (100%)

## Deferred

- **STREAM-PARTIAL**: Token-by-token text streaming to Telegram (send text as it arrives) — adds complexity, defer to v1.3
- **PROG-EDIT**: Show intermediate message with edit summary when Claude edits files — needs careful formatting
- **COST-01**: Show API cost from `result` event after each interaction — nice-to-have

---

*Archived: 2026-02-13*
